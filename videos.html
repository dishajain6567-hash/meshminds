<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Videos</title>

<link rel="stylesheet" href="css/futuristic.css">
<link rel="stylesheet" href="css/theme.css">

<style>
.page-box {
  max-width: 1000px;
  margin: 40px auto;
  background: var(--card);
  padding: 26px;
  border-radius: 16px;
  box-shadow: var(--shadow);
}
.video-card {
  background: var(--card);
  padding: 20px;
  border-radius: 16px;
  border: 1px solid var(--glass);
  margin-bottom: 26px;
  box-shadow: var(--shadow);
}
.video-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text);
}
.back-btn {
  padding: 8px 16px;
  background: var(--accent);
  color:#fff;
  border-radius:10px;
  border:none;
  cursor:pointer;
}
iframe {
  width: 100%;
  height: 315px;
  border-radius: 12px;
  border: none;
}
</style>
</head>
<body>

<header class="header-hero">
  <img src="img/hero.png" alt="Hero">
  <div class="hero-content">
    <h1>Videos</h1>
    <p id="path"></p>
  </div>
</header>

<div class="page-box">
  <h2 id="title"></h2>

  <div id="videoList"></div>

  <br>
  <button class="back-btn" onclick="history.back()">⬅ Back</button>
</div>

<script type="module">
import { db } from './js/firebase.js';
import { collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const course = localStorage.getItem("selectedCourse");
const branch = localStorage.getItem("selectedBranch");
const sem = localStorage.getItem("selectedSemester");
const subject = localStorage.getItem("selectedSubject");

document.getElementById("path").innerText = `${course} • ${branch} • ${sem}`;
document.getElementById("title").innerText = subject + " – Videos";

const out = document.getElementById("videoList");

loadVideos();

async function loadVideos(){
  try{
    const docId = `${course}__${branch}__${sem}__${subject}`;
    const q = query(collection(db, "videos", docId, "items"), orderBy("timestamp","desc"));
    const snap = await getDocs(q);

    if(snap.empty){
      out.innerHTML = `<p style="color:var(--muted)">No videos uploaded yet.</p>`;
      return;
    }

    snap.forEach(docSnap => {
      const d = docSnap.data();
      const title = d.title || "Video";
      const url = d.youtubeUrl;

      const embed = convertToEmbed(url);

      const card = document.createElement("div");
      card.className = "video-card";

      card.innerHTML = `
        <div class="video-title">${title}</div>
        <iframe src="${embed}" allowfullscreen></iframe>
      `;

      out.appendChild(card);
    });
  }
  catch(e){
    out.innerHTML = `<p class="card-desc">Error loading: ${e.message}</p>`;
  }
}

function convertToEmbed(url){
  if(!url) return "";
  try {
    // YouTube link handling
    if(url.includes("youtube.com/watch?v=")){
      return url.replace("watch?v=", "embed/");
    }
    if(url.includes("youtu.be/")){
      return url.replace("youtu.be/", "www.youtube.com/embed/");
    }
    // Playlist support
    if(url.includes("list=")){
      return `https://www.youtube.com/embed/videoseries?${url.split("?")[1]}`;
    }
  } catch(e){}

  return url;
}
</script>

<script type="module" src="js/theme.js"></script>
</body>
</html>
